#!/bin/bash

BASEDIR=$(dirname $(dirname $(readlink -f $0)))
# echo $BASEDIR

if [ "$1" = "" ]
then
  echo Warning: no file given
  exit
fi

FILE=$(dirname $1)/$(basename $1 ".curry")
if [ ! -f $FILE.curry ]
then
  echo Error: \"$FILE.curry\" not found
  exit
fi

parsecurry --flat $FILE
if [ $? = 0 ]
   then echo parsed
   else echo parse error ; exit
fi

# ------------------------------------------------------------------
# create ICurry

CURRYPATH=$PAKCSHOME/lib:$PAKCSHOME/lib/meta:$BASEDIR/icurry:$BASEDIR/format:$BASEDIR/backtrack
CURRYPATH=$BASEDIR/icurry:$BASEDIR/format:$BASEDIR/backtrack
export CURRYPATH

TARGET=$(dirname $1)/.curry/$(basename $1 ".curry")

# echo TARGET $TARGET

if [ -f $TARGET.read -a $TARGET.read -nt $FILE.curry ]
then
  echo \"read\" up to date
else
  rm -f $FILE.read 
  # command="pakcs -Dkeepfiles=yes :set v3 :set args $FILE :load $BASEDIR/icurry/Main.curry :eval main :quit"
  command="pakcs -q :set args $FILE :load $BASEDIR/icurry/Main.curry :eval Main.main :quit"
  echo CURRYPATH $CURRYPATH
  echo Running $command
  $command
  if [ -f $FILE.read ]
  then echo \"read\" file created
       mv -f $FILE.icur $TARGET.icur
       mv -f $FILE.read $TARGET.read
  else echo Fail to create  \"$FILE.read\" file
       exit 1
  fi
fi
