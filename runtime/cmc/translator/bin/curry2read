#!/bin/bash

THISDIR=`(cd \`dirname $0\` > /dev/null ; pwd)`
BASEDIR=`(cd $THISDIR/.. > /dev/null ; pwd)`

if [ "$*" = "" ]
then
  echo Warning: no file given
  exit
fi


LOCALLIBPATH=$BASEDIR/icurry:$BASEDIR
# export PAKCSLIBPATH
# echo PAKCSLIBPATH $PAKCSLIBPATH

for i in $*
do
  FILE=$(dirname $i)/$(basename $i ".curry")
  if [ ! -f $FILE.curry ]
  then
    echo Error: \"$FILE.curry\" not found
    exit
  fi

  CURRYPATH=`pwd`/$(dirname $i):$LOCALLIBPATH
  echo CURRYPATH $CURRYPATH
  export CURRYPATH

  parsecurry --flat $FILE
  if [ $?==0 ]
     then echo parsed
     else echo parse error ; exit
  fi

# create ICurry

  TARGET=$(dirname $i)/.curry/$(basename $i ".curry")

    rm -f $FILE.icur $FILE.read $TARGET.icur $TARGET.read
    command="pakcs -q -r $BASEDIR/icurry/Main.curry $FILE"
    echo Running $command
    $command
    if [ -f $FILE.icur ]
    then echo \"icur\" file created
         mv -f $FILE.icur $TARGET.icur
         mv -f $FILE.read $TARGET.read
    else echo Fail to create  \"icur\" file ; exit
    fi
    cat $TARGET.read

done


exit

